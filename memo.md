https://hackmd.io/EwIwhmwCYCwBwFoAMcCsBGBMBmB2JCAnEgMwDGCApieaobugGxiXBA==


近年、マイクロサービスアーキテクチャに注目が集まっています。そんな状況の中、米Lightbend社からマイクロサービスアーキテクチャ向けフレームワークの Lagom がリリースされました。Lagom は Reactive Manifesto で提唱されている Reactiveness を持つマイクロサービスの開発をサポートする、設計思想と機能を備えています。Reactiveness はシステムが大規模になるほど重要になってきます。この講演では Lagom の特徴的な設計思想や機能を取り上げ、マイクロサービスアーキテクチャを採用した大規模なシステムがとるべき振る舞いと、それが Lagom でどのように実現されているのかを解説します。

---

## 大規模な MSA の問題

* システムが大規模になるほど障害点が増えて障害の発生率が高くなる
* 多くのサービスが関連するためオーバーヘッドが大きくなる
* 多くのサービスの管理が大変

---

## Let it crash

* タイムアウト
* 隔壁

---

## Reactive MSA

* 全てを隔離する

* 自律的に働く
  * コーディネーションを排除すること
  * よりスケーラビリティ・レジリエンスが得られる？
* 一つのことを上手くやる
  * よりスケーラビリティ・レジリエンスが得られる？
* 状態を隔離する
  * よりスケーラビリティ・レジリエンスが得られる？
  * ステートレスアーキテクチャは、でかい DB を後ろに抱えている
* メッセージパッシングを備える
  * WebSocket
  * ノンブロッキング
* 可搬性を維持しながらアドレス可能にする
  * ロードバランス
  * フェイルオーバー
  * relocation of a stateful service

---

* Entityベースのスケーリング
  * 状態を持てるようになる
    * オーバーヘッドを減らす
* CQRS
  * Write のスケール
  * DDDでやりやすい？
* CircuitBreaker
  * 外部の障害に影響されないようにする
* BackoffSupervisor
  * 外部への負荷を減らす？
  * なぜ指数関数がいいのか？
* Asynchronous
  * パフォーマンスを上げる
  * 同期コミュニケーションの強い結合をなくす
* ServiceLocator

パターン一覧

- 非同期/ノンブロッキング
    - レイテンシを小さくする
    - but 過負荷
    - 外部サービスの障害時にスレッドが大量に生成されるのを防ぐ
- Timeout
    - 外部サービスの障害時にリソースの枯渇を防ぐ
- Circuit Breaker
    - 外部サービスの障害を切り離す
    - 復旧直後に外部サービスが過負荷になるのを防ぐ
- Event Sourcing + CQRS
    - （スケールが難しい）Update を廃して書き込みをスケールできるようにする
    - Event Sourcing
        - 書き込みをスケールアウトできるようにする
        - but 集計がしんどい
    - CQRS
        - イベントを集計しやすくする
        - but 結果整合
- Sharding によるステートフルなアーキテクチャ
    - 処理単位をスケールアウトできるようにする
    - 最新の状態のスナップショットをメモリ上に持つ
    - スナップショットは 1 箇所に限定されるため結果整合ではない
    - 自動復旧
    - but Split Brain

まとめ

